<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFra - La mia nutrizionista in tasca</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230F1A33'/><text x='50' y='65' font-size='60' text-anchor='middle' fill='%23E8B49A' font-family='serif'>M</text></svg>">
    <link rel="manifest" href="data:application/json,{%22name%22:%22MyFra%22,%22short_name%22:%22MyFra%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22theme_color%22:%22%230F1A33%22,%22background_color%22:%22%230F1A33%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%230F1A33'/%3E%3Ctext x='256' y='350' font-size='300' text-anchor='middle' fill='%23E8B49A' font-family='serif'%3EM%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyFra">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Montserrat:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0F1A33 0%, #1a2847 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0F1A33 0%, #1a2847 100%);
            color: white;
            padding: 35px 25px;
            text-align: center;
            position: relative;
        }

        .logo {
            font-family: 'Libre Baskerville', serif;
            font-size: 42px;
            font-weight: 700;
            color: #E8B49A;
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .tagline {
            font-size: 13px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: #E8B49A;
            opacity: 0.9;
            font-weight: 300;
        }

        .content {
            padding: 25px 20px 30px;
            background: #fafafa;
        }

        .loading {
            text-align: center;
            padding: 50px 20px;
        }

        .spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #E8B49A;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 26, 51, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .pin-modal-content {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .pin-modal h2 {
            color: #0F1A33;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .pin-modal p {
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }

        .pin-input {
            width: 100%;
            padding: 18px;
            font-size: 24px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 20px;
            letter-spacing: 8px;
            font-weight: 600;
        }

        .pin-input:focus {
            outline: none;
            border-color: #E8B49A;
        }

        .welcome {
            background: linear-gradient(135deg, #E8B49A 0%, #f0c9b3 100%);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 25px;
            text-align: center;
        }

        .welcome h2 {
            color: #0F1A33;
            font-size: 26px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .welcome p {
            color: #0F1A33;
            font-size: 14px;
            opacity: 0.8;
        }

        .status-card {
            background: white;
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 25px;
            text-align: center;
            border: 2px solid #f0f0f0;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .status-title {
            font-size: 20px;
            font-weight: 600;
            color: #0F1A33;
            margin-bottom: 12px;
        }

        .status-message {
            color: #666;
            line-height: 1.6;
            font-size: 15px;
        }

        .status-message a {
            color: #E8B49A;
            text-decoration: none;
            font-weight: 600;
            border-bottom: 2px solid #E8B49A;
        }

        .progress-card {
            background: white;
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 25px;
            border-left: 5px solid #E8B49A;
        }

        .progress-card h3 {
            color: #0F1A33;
            font-size: 18px;
            margin-bottom: 18px;
            font-weight: 600;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 35px;
            border-radius: 18px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #0F1A33 0%, #2a4166 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            transition: width 0.8s ease;
        }

        .progress-text {
            color: #666;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }

        .appointment-card {
            background: white;
            border-radius: 18px;
            padding: 25px;
            margin-bottom: 18px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .appointment-card:hover {
            border-color: #E8B49A;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(232, 180, 154, 0.15);
        }

        .appointment-card.next {
            border: 3px solid #E8B49A;
            background: linear-gradient(135deg, #fff9f5 0%, #ffffff 100%);
        }

        .appointment-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .badge-next {
            background: #E8B49A;
            color: white;
        }

        .badge-confirmed {
            background: #4A90E2;
            color: white;
        }

        .badge-completed {
            background: #95C97E;
            color: white;
        }

        .appointment-date {
            font-size: 20px;
            font-weight: 600;
            color: #0F1A33;
            margin-bottom: 10px;
        }

        .appointment-time {
            font-size: 16px;
            color: #666;
            margin-bottom: 6px;
        }

        .appointment-location {
            font-size: 14px;
            color: #999;
            margin-bottom: 18px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            margin-bottom: 10px;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-confirm {
            background: #0F1A33;
            color: #E8B49A;
        }

        .btn-confirm:hover {
            background: #1a2847;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(15, 26, 51, 0.25);
        }

        .btn-confirm:disabled {
            background: #ddd;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .btn-whatsapp {
            background: #E8B49A;
            color: #0F1A33;
        }

        .btn-whatsapp:hover {
            background: #d9a589;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 180, 154, 0.3);
        }

        .section-title {
            color: #0F1A33;
            font-size: 20px;
            margin: 30px 0 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid #E8B49A;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .space-myfra {
            background: white;
            padding: 30px 25px;
            border-radius: 18px;
            margin-top: 30px;
            border: 2px solid #f0f0f0;
        }

        .space-myfra h3 {
            color: #0F1A33;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .social-links {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px;
            background: #fafafa;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            text-decoration: none;
            color: #0F1A33;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .social-link:hover {
            border-color: #E8B49A;
            background: #fff9f5;
            transform: translateY(-2px);
        }

        .social-link.full-width {
            grid-column: 1 / -1;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        /* Admin Dashboard Styles */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #f0f0f0;
        }

        .stat-card.yellow { border-color: #FFC107; }
        .stat-card.blue { border-color: #4A90E2; }
        .stat-card.green { border-color: #95C97E; }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #0F1A33;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .admin-filters {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 25px;
        }

        .filter-input, .filter-select {
            padding: 10px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            font-size: 12px;
            font-family: 'Montserrat', sans-serif;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #E8B49A;
        }

        .admin-view-switch {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .view-btn {
            padding: 10px 16px;
            border: 2px solid #f0f0f0;
            background: white;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .view-btn.active {
            background: #0F1A33;
            color: #E8B49A;
            border-color: #0F1A33;
        }

        .view-btn:hover {
            border-color: #E8B49A;
        }

        .calendar-month {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #0F1A33;
            text-align: center;
            font-size: 12px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            min-height: 80px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            padding: 5px;
            font-size: 11px;
        }

        .calendar-day.empty {
            background: #fafafa;
        }

        .calendar-day.today {
            border-color: #E8B49A;
            background: #fff9f5;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 4px;
            color: #0F1A33;
        }

        .cal-event {
            padding: 3px 5px;
            margin: 2px 0;
            border-radius: 4px;
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cal-event.yellow { background: #FFF9C4; color: #F57F17; }
        .cal-event.blue { background: #E3F2FD; color: #1976D2; }
        .cal-event.green { background: #E8F5E9; color: #388E3C; }
        .cal-event.red { background: #FFEBEE; color: #D32F2F; }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .week-day {
            background: white;
            border-radius: 12px;
            padding: 12px;
            border: 2px solid #f0f0f0;
        }

        .week-day.today {
            border-color: #E8B49A;
            background: #fff9f5;
        }

        .week-day-header {
            font-weight: 600;
            color: #0F1A33;
            margin-bottom: 10px;
            font-size: 13px;
            text-align: center;
        }

        .week-event {
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 11px;
        }

        .week-event.yellow { background: #FFF9C4; color: #F57F17; }
        .week-event.blue { background: #E3F2FD; color: #1976D2; }
        .week-event.green { background: #E8F5E9; color: #388E3C; }
        .week-event.red { background: #FFEBEE; color: #D32F2F; }

        .admin-appointment-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #ddd;
        }

        .admin-appointment-card.yellow { border-left-color: #FFC107; }
        .admin-appointment-card.blue { border-left-color: #4A90E2; }
        .admin-appointment-card.green { border-left-color: #95C97E; }
        .admin-appointment-card.red { border-left-color: #F44336; }

        .admin-app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .admin-app-patient {
            font-size: 18px;
            font-weight: 600;
            color: #0F1A33;
        }

        .admin-app-status {
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 20px;
        }

        .admin-app-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .admin-app-confirmed {
            margin-top: 12px;
            padding: 10px;
            background: #E3F2FD;
            border-radius: 8px;
            font-size: 13px;
            color: #1976D2;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .admin-stats {
                grid-template-columns: 1fr;
            }
            .admin-filters {
                grid-template-columns: 1fr;
            }
            .admin-app-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .header { padding: 30px 20px; }
            .logo { font-size: 36px; }
            .content { padding: 20px 15px 25px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">MyFra</div>
            <div class="tagline">La mia nutrizionista in tasca</div>
        </div>

        <div class="content" id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Caricamento...</p>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQf5AVWZ2sGxpzEJKgBwUMi2tIenesth7O6RDE90zhck0b-s6T3vLYtFP0Y_-URvkFPFT9RWfyJJIGp/pub?gid=2027498395&single=true&output=csv';
        const WHATSAPP = '393349174413';
        const PIN_MASTER = 'MF-ADMIN';
        const SCRIPT_URL = 'YOUR_SCRIPT_URL_HERE'; // Da aggiornare dopo deploy

        const urlParams = new URLSearchParams(window.location.search);
        const userPIN = urlParams.get('pin');

        if (!userPIN) {
            showError('Link non valido. Contatta la Dott.ssa per ricevere il tuo link personale.');
        } else {
            checkPIN();
        }

        function checkPIN() {
            const stored = localStorage.getItem('myfra_pin');
            const storedCode = localStorage.getItem('myfra_code');

            if (stored && storedCode && stored === userPIN) {
                loadData();
            } else if (stored && stored !== userPIN) {
                showPINModal('Questo dispositivo √® collegato a un altro account. Inserisci il codice di sicurezza:', true);
            } else {
                showPINModal('Benvenuta! Per sicurezza, scegli un codice di 4 cifre che userai solo in caso di necessit√†:', false);
            }
        }

        function showPINModal(message, isVerify) {
            const modal = document.createElement('div');
            modal.className = 'pin-modal';
            modal.innerHTML = `
                <div class="pin-modal-content">
                    <h2>üîí Codice di sicurezza</h2>
                    <p>${message}</p>
                    <input type="number" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" id="pinInput">
                    <button class="btn btn-confirm" onclick="verifyPIN(${isVerify})">Conferma</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('pinInput').focus();
        }

        function verifyPIN(isVerify) {
            const input = document.getElementById('pinInput').value;
            if (input.length !== 4) {
                alert('Inserisci un codice di 4 cifre');
                return;
            }

            if (isVerify) {
                const stored = localStorage.getItem('myfra_code');
                if (input === stored) {
                    localStorage.setItem('myfra_pin', userPIN);
                    document.querySelector('.pin-modal').remove();
                    loadData();
                } else {
                    alert('Codice errato');
                }
            } else {
                localStorage.setItem('myfra_pin', userPIN);
                localStorage.setItem('myfra_code', input);
                document.querySelector('.pin-modal').remove();
                loadData();
            }
        }

        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const csv = await response.text();
                const data = parseCSV(csv);
                
                if (userPIN === PIN_MASTER) {
                    renderAdmin(data);
                } else {
                    renderPatient(data);
                }
            } catch (error) {
                showError('Errore di connessione. Riprova pi√π tardi.');
            }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((h, i) => row[h] = values[i] || '');
                return row;
            });
        }

        function renderPatient(data) {
            const patient = data.filter(r => r.PIN === userPIN);
            if (!patient.length) {
                showError('Nessun appuntamento trovato.');
                return;
            }

            const p = patient[0];
            const nome = p.Nome || '';
            const totali = parseInt(p.Visite_totali) || 0;
            const effettuate = parseInt(p.Visite_effettuate) || 0;
            const stato = p.Stato_paziente || 'Attivo';

            const today = new Date();
            today.setHours(0,0,0,0);

            const future = patient.filter(r => {
                const s = r.Stato_visita || '';
                return parseDate(r.Data) >= today && !['Annullata'].includes(s);
            }).sort((a,b) => parseDate(a.Data) - parseDate(b.Data));

            const past = patient.filter(r => {
                const s = r.Stato_visita || '';
                return parseDate(r.Data) < today && s === 'Svolta';
            }).sort((a,b) => parseDate(b.Data) - parseDate(a.Data));

            let html = `<div class="welcome"><h2>üëã Ciao ${nome}!</h2><p>Benvenuta nella tua area personale</p></div>`;

            // Status messages
            if (stato === 'Concluso') {
                html += `<div class="status-card"><div class="status-icon">üéâ</div><div class="status-title">Percorso concluso</div><div class="status-message">Resto disponibile se in futuro ne sentirai il bisogno.</div></div>`;
            } else if (stato === 'Sospeso') {
                html += `<div class="status-card"><div class="status-icon">‚è∏Ô∏è</div><div class="status-title">Percorso in pausa</div><div class="status-message">Quando senti che √® il momento giusto per riprendere, <a href="https://wa.me/${WHATSAPP}">contattami</a>, io ci sono.</div></div>`;
            }

            // Progress
            if (totali > 0) {
                const perc = Math.round((effettuate/totali)*100);
                html += `<div class="progress-card"><h3>üìä Percorso visite</h3><div class="progress-bar"><div class="progress-fill" style="width:${perc}%">${perc}%</div></div><p class="progress-text">${effettuate} di ${totali} visite completate</p></div>`;
            } else {
                html += `<div class="progress-card"><h3>‚ú® Cliente abituale</h3><p class="progress-text">Visite completate: ${effettuate}</p></div>`;
            }

            // Future appointments
            if (future.length) {
                html += '<h2 class="section-title">üìÖ Prossimi appuntamenti</h2>';
                future.forEach((a,i) => {
                    const confirmed = a.Conferma_appuntamento === 'TRUE' || a.Stato_visita === 'Confermata';
                    html += `<div class="appointment-card ${i===0?'next':''}">
                        ${i===0?'<span class="appointment-badge badge-next">üîú Prossimo</span>':''}
                        ${confirmed?'<span class="appointment-badge badge-confirmed">‚úì Confermato</span>':''}
                        <div class="appointment-date">${formatDate(a.Data)}</div>
                        <div class="appointment-time">üïí ${a.Ora}</div>
                        <div class="appointment-location">üìç ${a.Centro}</div>
                        ${!confirmed?`<button class="btn btn-confirm" onclick="confirm('${a.Data}')">‚úì Conferma</button>`:''}
                        <a href="https://wa.me/${WHATSAPP}?text=Ciao%20Dott.ssa%2C%20riguardo%20l%27appuntamento%20del%20${encodeURIComponent(formatDate(a.Data))}" class="btn btn-whatsapp">üí¨ Modifica/Annulla</a>
                    </div>`;
                });
            } else {
                html += '<div class="empty-state">üìÖ Nessun appuntamento programmato</div>';
            }

            // Past
            if (past.length) {
                html += '<h2 class="section-title">üìã Storico visite</h2>';
                past.slice(0,5).forEach(a => {
                    html += `<div class="appointment-card"><span class="appointment-badge badge-completed">‚úì Completata</span><div class="appointment-date">${formatDate(a.Data)}</div><div class="appointment-time">üïí ${a.Ora}</div><div class="appointment-location">üìç ${a.Centro}</div></div>`;
                });
            }

            // Space MyFra
            html += `<div class="space-myfra"><h3>üì± Spazio MyFra</h3><div class="social-links">
                <a href="https://sites.google.com/view/dottssafrancescabriscia/home-page" target="_blank" class="social-link">üåê Sito web</a>
                <a href="https://sites.google.com/view/dottssafrancescabriscia/approfondimenti" target="_blank" class="social-link">üìö Fra-day flash</a>
                <a href="https://www.facebook.com/share/15GkqfbzyJ/" target="_blank" class="social-link">üìò Facebook</a>
                <a href="https://www.instagram.com/dottssafrancescabriscia" target="_blank" class="social-link">üì∑ Instagram</a>
                <a href="https://wa.me/${WHATSAPP}" target="_blank" class="social-link full-width">üí¨ WhatsApp</a>
            </div></div>`;

            document.getElementById('app').innerHTML = html;
        }

        function renderAdmin(data) {
            const today = new Date();
            today.setHours(0,0,0,0);

            // Statistiche corrette
            const uniquePatients = [...new Set(data.map(r => r.PIN))];
            const attivi = uniquePatients.filter(pin => {
                const paziente = data.find(r => r.PIN === pin);
                return (paziente.Stato_paziente || 'Attivo') === 'Attivo';
            }).length;
            const conclusi = uniquePatients.filter(pin => {
                const paziente = data.find(r => r.PIN === pin);
                return paziente.Stato_paziente === 'Concluso';
            }).length;
            const sospesi = uniquePatients.filter(pin => {
                const paziente = data.find(r => r.PIN === pin);
                return paziente.Stato_paziente === 'Sospeso';
            }).length;
            
            const futureApps = data.filter(r => parseDate(r.Data) >= today);
            const programmate = futureApps.filter(r => (r.Stato_visita || 'Programmata') === 'Programmata').length;
            const confermate = futureApps.filter(r => r.Stato_visita === 'Confermata').length;
            const svolte = data.filter(r => r.Stato_visita === 'Svolta').length;
                            const notifiche = data.filter(r => r.Notifica_inviata === 'TRUE' || r.Notifica_inviata === true).length;

            let html = `
                <div class="welcome">
                    <h2>üë©üèª‚Äç‚öïÔ∏è Dashboard Admin</h2>
                    <p>Benvenuta Dott.ssa Briscia</p>
                </div>

                <div class="admin-view-switch">
                    <button class="view-btn active" onclick="switchView('list')">üìã Lista</button>
                    <button class="view-btn" onclick="switchView('month')">üìÖ Mese</button>
                    <button class="view-btn" onclick="switchView('week')">üìÜ Settimana</button>
                    <button class="view-btn" onclick="switchView('day')">üìÑ Giorno</button>
                </div>

                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number">${attivi}</div>
                        <div class="stat-label">Pazienti Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${conclusi}</div>
                        <div class="stat-label">Conclusi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${sospesi}</div>
                        <div class="stat-label">Sospesi</div>
                    </div>
                </div>

                <div class="admin-stats">
                    <div class="stat-card yellow">
                        <div class="stat-number">${programmate}</div>
                        <div class="stat-label">üü° Programmate</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-number">${confermate}</div>
                        <div class="stat-label">üîµ Confermate</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number">${svolte}</div>
                        <div class="stat-label">üü¢ Svolte</div>
                    </div>
                </div>

                <div class="admin-filters">
                    <input type="text" id="searchPatient" placeholder="üîç Cerca paziente..." class="filter-input">
                    <select id="filterCentro" class="filter-select">
                        <option value="">Tutti i centri</option>
                        ${[...new Set(data.map(r => r.Centro))].filter(c=>c).map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                    <select id="filterStato" class="filter-select">
                        <option value="">Tutti gli stati</option>
                        <option value="Programmata">üü° Programmata</option>
                        <option value="Confermata">üîµ Confermata</option>
                        <option value="Svolta">üü¢ Svolta</option>
                        <option value="Annullata">üî¥ Annullata</option>
                    </select>
                </div>

                <div id="adminContent"></div>
            `;

            document.getElementById('app').innerHTML = html;
            window.adminData = data;
            window.currentView = 'list';
            renderAdminView('list');

            document.getElementById('searchPatient').addEventListener('input', () => renderAdminView(window.currentView));
            document.getElementById('filterCentro').addEventListener('change', () => renderAdminView(window.currentView));
            document.getElementById('filterStato').addEventListener('change', () => renderAdminView(window.currentView));
        }

        function switchView(view) {
            window.currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderAdminView(view);
        }

        function renderAdminView(view) {
            const data = window.adminData;
            const search = document.getElementById('searchPatient')?.value.toLowerCase() || '';
            const centro = document.getElementById('filterCentro')?.value || '';
            const stato = document.getElementById('filterStato')?.value || '';

            let filtered = data.filter(r => {
                const matchSearch = !search || 
                    (r.Nome || '').toLowerCase().includes(search) || 
                    (r.Cognome || '').toLowerCase().includes(search) ||
                    (r.PIN || '').toLowerCase().includes(search);
                const matchCentro = !centro || r.Centro === centro;
                const matchStato = !stato || (r.Stato_visita || 'Programmata') === stato;
                return matchSearch && matchCentro && matchStato;
            });

            if (view === 'list') {
                renderListView(filtered);
            } else if (view === 'month') {
                renderMonthView(filtered);
            } else if (view === 'week') {
                renderWeekView(filtered);
            } else if (view === 'day') {
                renderDayView(filtered);
            }
        }

        function renderListView(data) {
            data.sort((a,b) => parseDate(a.Data) - parseDate(b.Data));
            let html = '<h2 class="section-title">üìã Lista appuntamenti</h2>';
            
            if (data.length === 0) {
                html += '<div class="empty-state">Nessun appuntamento trovato</div>';
            } else {
                data.forEach(app => {
                    const stato = app.Stato_visita || 'Programmata';
                    const colorClass = {
                        'Programmata': 'yellow',
                        'Confermata': 'blue',
                        'Svolta': 'green',
                        'Annullata': 'red'
                    }[stato] || 'yellow';
                    const icon = {'Programmata':'üü°','Confermata':'üîµ','Svolta':'üü¢','Annullata':'üî¥'}[stato] || 'üü°';
                    const notifica = app.Notifica_inviata === 'TRUE' || app.Notifica_inviata === true;

                    html += `
                        <div class="admin-appointment-card ${colorClass}">
                            <div class="admin-app-header">
                                <div class="admin-app-patient">${app.Nome} ${app.Cognome}</div>
                                <div class="admin-app-status">${icon} ${stato}</div>
                            </div>
                            <div class="admin-app-details">
                                <div>üìÖ ${formatDate(app.Data)}</div>
                                <div>üïí ${app.Ora}</div>
                                <div>üìç ${app.Centro}</div>
                                <div>üÜî ${app.PIN}</div>
                                ${notifica ? '<div style="grid-column:1/-1;">üìß Notifica inviata ‚úì</div>' : ''}
                            </div>
                            ${app.Conferma_appuntamento === 'TRUE' ? '<div class="admin-app-confirmed">‚úì Confermato</div>' : ''}
                        </div>
                    `;
                });
            }
            document.getElementById('adminContent').innerHTML = html;
        }

        function renderMonthView(data) {
            if (!window.currentMonth) {
                window.currentMonth = new Date();
            }
            const year = window.currentMonth.getFullYear();
            const month = window.currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();

            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <button class="view-btn" onclick="changeMonth(-1)">‚Üê Mese prec</button>
                    <h2 class="section-title" style="margin:0; border:none; padding:0;">${firstDay.toLocaleDateString('it-IT',{month:'long',year:'numeric'})}</h2>
                    <button class="view-btn" onclick="changeMonth(1)">Mese succ ‚Üí</button>
                </div>
            `;
            html += '<div class="calendar-month"><div class="calendar-header">';
            ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'].forEach(d => html += `<div>${d}</div>`);
            html += '</div><div class="calendar-days">';

            for(let i=0; i<startDay; i++) html += '<div class="calendar-day empty"></div>';
            
            const today = new Date();
            for(let day=1; day<=daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = `${String(day).padStart(2,'0')}/${String(month+1).padStart(2,'0')}/${year}`;
                const apps = data.filter(r => formatDateSimple(r.Data) === dateStr);
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                
                html += `<div class="calendar-day ${isToday?'today':''}">
                    <div class="day-number">${day}</div>`;
                apps.forEach(a => {
                    const color = {'Programmata':'yellow','Confermata':'blue','Svolta':'green','Annullata':'red'}[a.Stato_visita||'Programmata']||'yellow';
                    html += `<div class="cal-event ${color}">${a.Ora} ${a.Nome}</div>`;
                });
                html += '</div>';
            }
            html += '</div></div>';
            document.getElementById('adminContent').innerHTML = html;
        }

        function changeMonth(dir) {
            window.currentMonth.setMonth(window.currentMonth.getMonth() + dir);
            renderAdminView('month');
        }

        function renderWeekView(data) {
            if (!window.currentWeekStart) {
                window.currentWeekStart = new Date();
                window.currentWeekStart.setDate(window.currentWeekStart.getDate() - window.currentWeekStart.getDay() + 1);
            }
            
            const startOfWeek = new Date(window.currentWeekStart);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <button class="view-btn" onclick="changeWeek(-1)">‚Üê Settimana prec</button>
                    <h2 class="section-title" style="margin:0; border:none; padding:0;">Settimana ${startOfWeek.toLocaleDateString('it-IT',{day:'numeric',month:'short'})} - ${endOfWeek.toLocaleDateString('it-IT',{day:'numeric',month:'short'})}</h2>
                    <button class="view-btn" onclick="changeWeek(1)">Settimana succ ‚Üí</button>
                </div>
            `;
            html += '<div class="calendar-week">';
            
            const today = new Date();
            for(let i=0; i<7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateStr = formatDateSimple2(day);
                const apps = data.filter(r => formatDateSimple(r.Data) === dateStr);
                const isToday = day.toDateString() === today.toDateString();
                
                html += `<div class="week-day ${isToday?'today':''}">
                    <div class="week-day-header">${day.toLocaleDateString('it-IT',{weekday:'short',day:'numeric',month:'short'})}</div>`;
                apps.sort((a,b)=>a.Ora.localeCompare(b.Ora)).forEach(a => {
                    const color = {'Programmata':'yellow','Confermata':'blue','Svolta':'green','Annullata':'red'}[a.Stato_visita||'Programmata']||'yellow';
                    const notifica = (a.Notifica_inviata === 'TRUE' || a.Notifica_inviata === true) ? ' ‚úì' : '';
                    html += `<div class="week-event ${color}">${a.Ora} ${a.Nome}${notifica}</div>`;
                });
                html += '</div>';
            }
            html += '</div>';
            document.getElementById('adminContent').innerHTML = html;
        }

        function changeWeek(dir) {
            window.currentWeekStart.setDate(window.currentWeekStart.getDate() + (dir * 7));
            renderAdminView('week');
        }

        function renderDayView(data) {
            const now = new Date();
            const dateStr = formatDateSimple2(now);
            const apps = data.filter(r => formatDateSimple(r.Data) === dateStr).sort((a,b)=>a.Ora.localeCompare(b.Ora));
            
            let html = `<h2 class="section-title">üìÑ Oggi ${now.toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long'})}</h2>`;
            
            if(apps.length === 0) {
                html += '<div class="empty-state">Nessun appuntamento oggi</div>';
            } else {
                apps.forEach(a => {
                    const color = {'Programmata':'yellow','Confermata':'blue','Svolta':'green','Annullata':'red'}[a.Stato_visita||'Programmata']||'yellow';
                    html += `<div class="admin-appointment-card ${color}">
                        <div class="admin-app-header">
                            <div class="admin-app-patient">${a.Nome} ${a.Cognome}</div>
                            <div class="admin-app-status">${a.Ora}</div>
                        </div>
                        <div class="admin-app-details">
                            <div>üìç ${a.Centro}</div>
                            <div>üÜî ${a.PIN}</div>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('adminContent').innerHTML = html;
        }

        function formatDateSimple(d) {
            const date = parseDate(d);
            return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()}`;
        }

        function formatDateSimple2(d) {
            return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        }

        function parseDate(d) {
            if(!d) return new Date(0);
            const p = d.split('/');
            return p.length===3 ? new Date(p[2],p[1]-1,p[0]) : new Date(d);
        }

        function formatDate(d) {
            return parseDate(d).toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
        }

        function confirm(date) {
            alert('Appuntamento confermato! ‚úì');
            // Qui andr√† chiamata al Google Apps Script
        }

        function showError(msg) {
            document.getElementById('app').innerHTML = `<div class="error">‚ö†Ô∏è ${msg}</div><a href="https://wa.me/${WHATSAPP}" class="btn btn-whatsapp">üí¨ Contatta su WhatsApp</a>`;
        }
    </script>
</body>
</html>
